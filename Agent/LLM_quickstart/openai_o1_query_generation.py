from openai import OpenAI;from dotenv import load_dotenv;import os;load_dotenv()
openai = OpenAI(api_key=os.getenv("OPENAI_API_KEY"), base_url="https://api.openai.com/v1");import pandas as pd; import json

def get_key(msg):
    completion=openai.chat.completions.create(model="o1-preview",messages=[{"role":"user","content":f"""
- 너는 query문을 생성하는 전문가야
- 너는 [사용자와의 기존 대화]를 마지막까지 차분히 읽고 사용자가 궁금해하는 내용을 한 개의 query문으로 만들꺼야.
- 그 query문은 나중에 벡터화되서, 내부 벡터 데이터베이스에서 사용자 질문과 관련한 문서를 찾아오는 retrieval system의 검색 query로 사용될꺼야. 
- 현재 retrieval system은 elasticsearch, KR-SBERT를 사용중이고, BGE-M3를 사용할 예정이야.
- 내부 데이터베이스에는 4200개의 문서가 있고 각 문서별 대략 500토큰 미만 길이로 구성되어 있어
- 가장 정확하게 사용자의 질문과 관련있는 문서를 추출할 수 있는 query문을 만들어줘.
- 답변은 한 개의 query문으로만 출력해야 해.
- query문은 한국어로 작성해야 해.
- 내부 데이터베이스 [문서의 예시]와 [전체 요약문]을 참고해서 가장 효과적인 query를 만들어줘. 

[문서의 예시]
"토성의 고리는 얼음과 암석 조각으로 이루어져 있습니다. 이 고리는 토성의 중력과 위성들의 영향으로 형성되었으며, 지름이 약 270,000km에 이르는 거대한 구조물입니다. 고리는 수많은 작은 조각들로 이루어져 있으며, 이 조각들은 토성 주위를 돌며 고리를 형성합니다. 이 고리는 토성의 아름다운 특징 중 하나로 알려져 있으며, 많은 우주 탐사선들이 이 고리를 관찰하고 연구하고 있습니다."

[문서의 예시]
"덤불 생태계는 쥐, 토끼, 보브캣, 다람쥐 등 다양한 동물들이 서식하는 환경입니다. 이들 동물들은 서로 다른 생태적 역할을 수행하며, 서로에게 영향을 미치고 있습니다. 그 중에서도 보브캣은 다른 세 종의 동물들의 개체 수가 계속 감소한다면 가장 어려움을 겪을 것으로 예상됩니다.\n\n보브캣은 덤불 생태계에서 중요한 포식자로서의 역할을 수행합니다. 이 동물은 주로 쥐와 토끼를 사냥하여 먹는데, 이를 통해 생태계의 균형을 유지하고 있습니다. 그러나 다른 세 종의 동물들의 개체 수가 감소한다면 보브캣은 먹이를 찾기 어려워질 것입니다.\n\n덤불 생태계에서 쥐와 토끼는 식물을 먹는 동물들에게 중요한 먹이로서 기능합니다. 이들 동물들이 감소한다면 식물을 먹는 동물들은 먹이를 찾기 어려워질 것입니다. 이는 보브캣에게도 영향을 미칠 것입니다. 보브캣은 먹이를 찾기 어려워지면 생존에 어려움을 겪을 것입니다.\n\n또한 다람쥐는 덤불 생태계에서 중요한 씨앗 산란자로서의 역할을 수행합니다. 이들 동물들이 감소한다면 식물들의 번식에도 영향을 미칠 것입니다. 이는 보브캣에게도 영향을 미칠 것입니다. 보브캣은 씨앗을 먹는 동물들이 감소하면 먹이를 찾기 어려워질 것입니다.\n\n따라서, 다른 세 종의 동물들의 개체 수가 계속 감소한다면 보브캣이 생존하는 데 가장 어려움을 겪을 것으로 예상됩니다. 보브캣은 먹이를 찾기 어려워지고, 생태계의 균형이 깨질 가능성이 큽니다. 이에 대한 보호와 보전이 필요합니다."

[전체 요약문]
기업 내부 데이터베이스는 과학 전반에 걸친 다양한 분야와 주제를 포함하고 있습니다. 주요 분야와 내용은 다음과 같습니다.

### **1. 생물학 및 생명과학**

- **인체 생리학과 건강**
  - **영양소의 역할**: 비타민 A의 시력 유지, 아연의 상처 치유, 비타민 B6와 B12 결핍이 치매와 유사한 증상 유발, 칼륨 섭취가 고혈압 개선에 미치는 영향.
  - **노화와 면역 체계**: 노화 이론의 비교, 노인의 면역 기능 변화와 건강 영향, 노년기 신경증 증가와 사망률의 상관관계.
  - **운동과 에너지 대사**: 운동선수의 체력 향상 방법, 근육 운동 시 ATP 생산과 에너지 사용 과정.

- **유전학과 유전 질환**
  - **유전적 형질과 돌연변이**: 낫적혈구빈혈증과 지중해빈혈의 유전적 원인 및 패턴, G6PD 결핍의 유전적 특징과 영향.
  - **세포 및 분자 생물학**: 원핵세포와 진핵세포의 구조와 공통점, 세포 소기관의 기능(리보솜, 세포막, DNA 등).

- **생태학 및 환경 생물학**
  - **생태계와 먹이사슬**: 먹이 그물의 구성과 한계, 분해자의 역할, 생물 사이의 상호작용.
  - **적응과 진화**: 동물의 환경 적응 사례, 북극곰의 지방 축적, 색상 변화 능력을 통한 생존 전략.

- **식물학**
  - **식물의 구조와 기능**: 식물 세포의 특수 조직, 잎의 팽압과 수분 손실, 광합성 메커니즘.
  - **씨앗의 발아와 성장**: 온도가 씨앗 발아에 미치는 영향, 식물의 에너지 활용 방식.

---

### **2. 화학**

- **화학 원리와 반응**
  - **물질의 특성과 반응성**: 니오븀의 화학적 성질, HClO₃의 산성 강도, 알루미늄 염화물의 이온화.
  - **산과 염기, 용해도**: 강산과 강염기의 중화 반응, 헨리의 법칙과 기체 용해도, 몰 용해도와 용해도곱(Ksp).

- **유기화학과 분석화학**
  - **유기 화합물의 구조와 명명법**: 탄화수소의 명명법, CH₃CHBrCHClCH₂CH₃의 구조 분석.
  - **분광학적 분석 방법**: 리드베르크 방정식을 이용한 수소 스펙트럼 분석, 13C NMR을 통한 분자 구조 확인.

---

### **3. 물리학**

- **역학과 에너지**
  - **운동의 법칙**: 뉴턴의 운동 법칙 적용, 마찰력과 경사로에서의 알짜힘 계산.
  - **에너지 전환과 보존**: 위치 에너지와 운동 에너지의 상호 변환, 열에너지와 엔트로피 개념.

- **전기와 자기**
  - **전기 회로와 전자기 현상**: 전구에서의 전기 에너지 변환, 전자기파의 특성, 전자석의 자장 강도 조절.
  - **빛의 성질과 광학**: 빛의 산란으로 인한 하늘의 색 변화, 굴절 망원경의 원리, 물질의 투명성과 불투명성.

- **열역학과 물질의 상태 변화**
  - **열 에너지 전달**: 전도, 대류, 복사에 의한 열 전달 방식.
  - **양자역학과 상대성 이론**: 파울리 배타 원리, 전자 배치와 화학 반응, 상대성 이론의 광학적 현상 응용.

---

### **4. 지구과학 및 천문학**

- **지질학과 판구조론**
  - **지구의 내부 구조와 활동**: 지각 운동, 화산 활동, 지진 발생 메커니즘.
  - **암석과 광물**: 암석의 형성 과정과 분류, 광물의 화학적 특성.

- **천문학**
  - **태양계와 우주**: 행성들의 특징 비교, 별의 생명 주기와 핵융합 과정, 블랙홀의 성질.
  - **지구와 달의 운동**: 자전과 공전이 지구 환경에 미치는 영향, 일식과 월식의 원리.

- **기상학과 기후학**
  - **대기 현상과 기후 변화**: 기상 시스템 분석, 온실 효과와 지구 온난화, 기후 변화의 원인과 영향.

---

### **5. 환경과학 및 생태계**

- **환경 문제와 자원 관리**
  - **오염과 대책**: 산성비의 발생 원인, 대기 및 수질 오염의 영향, 환경 친화적 에너지 자원 활용.
  - **재활용과 지속 가능성**: 자원 보존의 중요성, 재생 에너지의 개발과 적용.

- **생태계 보전**
  - **생물 다양성**: 멸종 위기 종 보호, 생태계 복원 노력.
  - **인간 활동의 영향**: 삼림 벌채, 서식지 파괴, 농업 활동이 생태계에 미치는 영향.

---

### **6. 공학 및 기술**

- **에너지 기술**
  - **재생 가능 에너지**: 태양광 발전, 풍력 발전의 원리와 응용.
  - **전력 시스템**: 전기 회로 설계, 전압과 저항의 관계, 에너지 효율 향상 기술.

- **정보 기술 및 보안**
  - **프로그래밍과 알고리즘**: 프로그래밍 언어의 활용, 자료 구조와 알고리즘 분석.
  - **네트워크와 보안**: TCP/IP 프로토콜, 사이버 보안 위협과 대응 방안, 암호화 기술.

- **재료공학 및 환경공학**
  - **신소재 개발**: 금속과 합금의 특성, 반도체의 활용.
  - **환경 기술**: 폐기물 관리, 물 정화 기술, 지속 가능한 기술 개발.

---

### **7. 의학 및 건강**

- **질병과 면역**
  - **전염병의 원인과 예방**: 바이러스와 세균의 감염 메커니즘, 백신 개발의 중요성.
  - **유전 질환 관리**: 테이새크스병, 지중해빈혈 등 유전 질환의 원인과 치료 접근법.

- **영양과 대사**
  - **영양소의 소화와 흡수**: 탄수화물, 단백질, 지방의 대사 과정.
  - **건강한 식습관**: 비만 예방, 심혈관 질환과 식단의 관계.

---

### **8. 사회과학 및 심리학**

- **인구 통계와 사회 문제**
  - **노화의 사회적 영향**: 고령화로 인한 사회 변화, 노인 복지와 지원 정책.
  - **건강과 복지**: 사회적 지원이 개인 건강에 미치는 영향, 노인 학대 예방.

- **심리학과 행동 과학**
  - **인간의 발달과 성격**: 발달 심리학의 이론, 성격 형성과 행동 특성.
  - **정신 건강**: 스트레스와 신경증, 정신 질환의 원인과 치료 방법.

---

### **9. 과학적 연구 방법론**

- **실험 설계와 데이터 분석**
  - **과학적 방법론**: 가설 설정, 실험 계획 수립, 데이터 수집 및 해석.
  - **데이터 신뢰성과 정확성**: 실험의 반복성, 오차 분석, 통계적 유의성 평가.

- **과학사와 과학자들**
  - **과학의 역사적 발전**: 주요 과학적 발견과 혁신, 과학자들의 업적과 영향.

---

### **10. 기타 과학 지식**

- **최신 과학 기술**
  - **우주 탐사 및 기술 발전**: 우주 탐사의 역사와 최신 동향, 탐사 기술의 발전.
  - **나노기술과 유전자 공학**: 나노기술의 응용 분야, 유전자 편집 기술의 원리와 윤리적 이슈.

- **과학의 본질과 철학**
  - **과학 지식의 진화**: 새로운 발견에 따른 이론의 수정과 발전 과정.
  - **자연 현상에 대한 이해**: 과학적 사고 방식과 철학적 접근.
  
[사용자와의 기존 대화]
{msg}
"""
}])    
    ans=completion.choices[0].message.content
    print(ans)
    return ans

# JSONL 파일 불러오기
file_path='/data/ephemeral/home/upstageailab-ir-competition-ir_s3/baseline/data/eval_added_intent.jsonl' 
df=pd.read_json(file_path, lines=True)
df['query']=[get_key(msg) for msg in df['msg']]

print(df.head(30)) # 데이터프레임 확인

df.to_csv('/data/ephemeral/home/upstageailab-ir-competition-ir_s3/baseline/data/eval_added_query.csv', index=False, encoding='utf-8-sig')
df.to_json('/data/ephemeral/home/upstageailab-ir-competition-ir_s3/baseline/data/eval_added_query.jsonl',orient='records', lines=True, force_ascii=False)